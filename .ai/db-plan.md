1. List of tables with their columns, data types, and constraints
- **auth.users** (Supabase managed)

  Supabase Auth manages this table and stores the canonical user identity (`id`, `email`, timestamps). Treat it as read-only from the public schema and hydrate profile data through companion tables.

  Columns (non-exhaustive):
  - `id uuid` — primary key generated by Supabase Auth
  - `email text` — nullable until confirmed; managed by Supabase
  - `encrypted_password text` — password hash managed by Supabase Auth (BCrypt)
  - `created_at timestamptz` — user creation timestamp
  - `updated_at timestamptz` — last modification timestamp

- **user_roles**

  Columns:
  - `user_id uuid` — primary key; references `auth.users(id)` on delete cascade; role metadata per user
  - `role user_role_enum` — not null default `'user'`; allowed values `user`, `admin`
  - `created_at timestamptz` — not null default `now()`
  - `updated_at timestamptz` — not null default `now()`; keep fresh via trigger

- **user_preferences**

  Columns:
  - `user_id uuid` — primary key; references `auth.users(id)` on delete cascade; one row per user
  - `people_count smallint` — not null; check `(people_count between 1 and 20)`; defaults from onboarding
  - `trip_type trip_type_enum` — not null; values `leisure`, `business`
  - `comfort comfort_level_enum` — not null; values `relax`, `balanced`, `intense`
  - `budget budget_level_enum` — not null; values `budget`, `moderate`, `luxury`
  - `age smallint` — not null; check `(age between 13 and 120)`
  - `country text` — not null; check `(char_length(country) between 2 and 120)`; store ISO name or code
  - `created_at timestamptz` — not null default `now()`
  - `updated_at timestamptz` — not null default `now()`

- **plans**

  Columns:
  - `id uuid` — primary key; default `gen_random_uuid()`
  - `owner_id uuid` — not null; references `auth.users(id)` on delete cascade
  - `name text` — not null; check `(char_length(name) between 1 and 140)`; editable title
  - `destination_text text` — not null; check `(char_length(destination_text) between 1 and 160)`
  - `date_start date` — not null
  - `date_end date` — not null; check `(date_end >= date_start)`; max 30-day span enforced in API
  - `people_count smallint` — not null; check `(people_count between 1 and 20)`; per-plan override
  - `trip_type trip_type_enum` — not null
  - `comfort comfort_level_enum` — not null
  - `budget budget_level_enum` — not null
  - `transport_modes transport_mode_enum[]` — null allowed; empty array lets AI decide
  - `note_text text` — not null; check `(char_length(note_text) <= 20000)`; original user note
  - `created_at timestamptz` — not null default `now()`
  - `updated_at timestamptz` — not null default `now()`

- **plan_days**

  Columns:
  - `id uuid` — primary key; default `gen_random_uuid()`
  - `plan_id uuid` — not null; references `plans(id)` on delete cascade
  - `day_index smallint` — not null; check `(day_index between 1 and 30)`; sequential day counter
  - `day_date date` — not null; should align with plan dates
  - `created_at timestamptz` — not null default `now()`
  - `updated_at timestamptz` — not null default `now()`

- **plan_blocks**

  Columns:
  - `id uuid` — primary key; default `gen_random_uuid()`
  - `day_id uuid` — not null; references `plan_days(id)` on delete cascade
  - `block_type block_type_enum` — not null; values `morning`, `afternoon`, `evening`
  - `created_at timestamptz` — not null default `now()`

- **plan_activities**

  Columns:
  - `id uuid` — primary key; default `gen_random_uuid()`
  - `block_id uuid` — not null; references `plan_blocks(id)` on delete cascade
  - `title text` — not null; check `(char_length(title) between 1 and 200)`; activity label
  - `duration_minutes smallint` — not null; check `(duration_minutes between 5 and 720)`
  - `transport_minutes smallint` — null; check `(transport_minutes between 0 and 600)`; optional travel time
  - `order_index smallint` — not null; check `(order_index between 1 and 50)`; ordering within block
  - `created_at timestamptz` — not null default `now()`
  - `updated_at timestamptz` — not null default `now()`

- **events**

  Columns:
  - `id uuid` — primary key; default `gen_random_uuid()`
  - `user_id uuid` — not null; references `auth.users(id)` on delete cascade
  - `plan_id uuid` — references `plans(id)` on delete set null; nullable for account events
  - `event_type event_type_enum` — not null; enumerated analytics events
  - `destination_text text` — null; check `(char_length(destination_text) <= 160)`; optional snapshot
  - `transport_modes transport_mode_enum[]` — null; optional for plan events
  - `trip_length_days smallint` — null; check `(trip_length_days between 1 and 30)`; optional
  - `created_at timestamptz` — not null default `now()`

2. Relationships between tables
- auth.users 1↔1 user_roles via user_id primary/foreign key
- auth.users 1↔1 user_preferences via user_id primary/foreign key
- auth.users 1↔n plans via plans.owner_id
- plans 1↔n plan_days via plan_days.plan_id
- plan_days 1↔n plan_blocks via plan_blocks.day_id
- plan_blocks 1↔n plan_activities via plan_activities.block_id
- auth.users 1↔n events via events.user_id
- plans 1↔n events via events.plan_id (nullable, retains analytics after plan deletion)

3. Indexes
- `create index user_roles_role_idx on user_roles(role)` — quick lookups for admin role membership
- `create index plans_owner_created_idx on plans(owner_id, created_at desc)` — list plans per user ordered by recency
- `create unique index plan_days_plan_day_index_idx on plan_days(plan_id, day_index)` — enforce single row per day number
- `create unique index plan_days_plan_day_date_idx on plan_days(plan_id, day_date)` — prevent duplicate dates inside one plan
- `create unique index plan_blocks_day_type_idx on plan_blocks(day_id, block_type)` — ensure only one block of each type per day
- `create unique index plan_activities_block_order_idx on plan_activities(block_id, order_index)` — maintain deterministic ordering within blocks
- `create index events_user_created_idx on events(user_id, created_at desc)` — support analytics by user and time
- `create index events_type_created_idx on events(event_type, created_at desc)` — aggregate events by type

4. PostgreSQL policies (RLS)
- Enable row level security on `user_roles`, `user_preferences`, `plans`, `plan_days`, `plan_blocks`, `plan_activities`, `events`
- `user_roles`: allow select/update where `user_id = auth.uid()`; permit inserts/updates via service role; allow admins (`role = 'admin'`) to select all
- `user_preferences`: allow select/insert/update/delete where `user_id = auth.uid()`; allow service role maintenance
- `plans`: allow select/update/delete where `owner_id = auth.uid()`; allow insert with check `owner_id = auth.uid()`; allow admins to select all for support/metrics
- `plan_days`: allow select/update/delete where the parent plan belongs to `auth.uid()`; enforce same check on insert; allow admins select via parent join
- `plan_blocks`: mirror `plan_days` policy using parent plan ownership
- `plan_activities`: mirror `plan_days` policy using parent plan ownership
- `events`: allow insert/select where `user_id = auth.uid()`; allow admins select all; optionally allow analytics service role to select/export

5. Additional notes or explanations
- Enumerated types: create type user_role_enum as enum('user','admin'); trip_type_enum as enum('leisure','business'); comfort_level_enum as enum('relax','balanced','intense'); budget_level_enum as enum('budget','moderate','luxury'); block_type_enum as enum('morning','afternoon','evening'); event_type_enum as enum('account_created','preferences_completed','plan_generated','plan_regenerated','plan_edited','plan_deleted'); transport_mode_enum as enum('car','walk','public')
- Enable pgcrypto extension (or use uuid-ossp) for gen_random_uuid(); apply trigger to auto-update updated_at columns (e.g., using trigger function set_updated_at)
- Enforce 10-plan-per-user limit and max 30-day range in application/service layer as planned; database checks prevent inverted date ranges but not duration
- Consider server-side validation ensuring plan_days.day_date falls within plan date range; implement via constraint trigger or API guard if needed
- Events table keeps optional context columns lightweight to satisfy analytics requirements without JSON storage; extend cautiously if new metrics appear
