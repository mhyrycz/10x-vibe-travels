---
import Layout from "@/layouts/Layout.astro";
import CreatePlanPage from "@/components/create-plan/CreatePlanPage";
import { getUserPreferences } from "@/lib/services/userPreferences.service";

// Get authenticated user from middleware
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

// Get Supabase client from context
const supabase = Astro.locals.supabase;

// Check if user has completed preferences (required before creating plans)
const preferencesResult = await getUserPreferences(supabase, user.id);

// If preferences don't exist, redirect to onboarding first
if (!preferencesResult.success) {
  return Astro.redirect("/onboarding/preferences");
}
---

<Layout title="Create New Plan - VibeTravels">
  <CreatePlanPage client:only="react" />
</Layout>
